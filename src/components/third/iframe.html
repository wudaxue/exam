<!doctype html>
<html>
<head><meta charset="utf-8"/><title>Iframe 通信示例</title></head>
<body>
  <h3 id="title">Iframe</h3>
  <div>
    <button id="btnInvokeOther">Invoke 另一个 iframe（通过 parent）</button>
  </div>
  <script>
    // 读取 URL 参数 id 与 token
    function getQuery(){
      const qs = {};
      location.search.slice(1).split('&').forEach(pair => {
        if(!pair) return;
        const [k,v] = pair.split('=');
        qs[decodeURIComponent(k)] = decodeURIComponent(v || '');
      });
      return qs;
    }
    const q = getQuery();
    const myId = q.id || ('iframe_' + Math.random().toString(36).slice(2,7));
    const myToken = q.token || '';

    document.getElementById('title').textContent = `Iframe: ${myId}`;

    function base64Encode(obj){ return btoa(JSON.stringify(obj)); }
    function base64Decode(str){ try { return JSON.parse(atob(str)); } catch(e){ return null; } }
    function genKey(){ return 'k_' + Date.now() + '_' + Math.random().toString(36).slice(2,9); }

    // 注册到 parent
    window.parent.postMessage({ type:'register', id: myId, token: myToken }, '*');

    // 接收来自 parent 的消息
    window.addEventListener('message', async (ev) => {
      const msg = ev.data;
      if (!msg || !msg.type) return;
      // console.log(myId, 'recv', msg);

      if (msg.type === 'register_ack'){
        console.log(`${myId} 已向父页面注册成功`);
        return;
      }

      if (msg.type === 'invoke'){
        // 收到调用请求：打印解密后的 payload，并返回执行成功
        const payload = base64Decode(msg.payload);
        // 根据你的测试场景输出指定格式
        if (msg.from === 'parent'){
          console.log(`${myId} 收到来自主页面的消息： ${JSON.stringify(payload)}`);
        } else {
          // iframe <- iframe via parent: msg.via 表示中转 host
          console.log(`${myId} 收到来自 ${msg.from} 的消息： ${JSON.stringify(payload)}，从${msg.via || 'unknown host'}中转`);
        }
        // 做完动作后返回结果给 parent（parent 会把结果中转回调用方）
        const resp = { type:'response', key: msg.key, from: myId, to: msg.from, payload: base64Encode({ status:'done', key: msg.key }) };
        // 如果目标是 parent，直接发回；否则也发到 parent 由 parent 中转
        window.parent.postMessage(resp, '*');
        return;
      }

      if (msg.type === 'response'){
        // 这里是这个 iframe 收到某个 response（如果这个 iframe 发起了调用）
        const decoded = base64Decode(msg.payload);
        console.log(`${myId} 收到调用成功结果：${msg.key}`, decoded);
      }

      if (msg.type === 'error'){
        console.warn(`${myId} 收到错误：`, msg);
      }
    });

    // 如果 iframe 要调用另一个 iframe（通过 parent）
    document.getElementById('btnInvokeOther').addEventListener('click', () => {
      // 举例：iframe2 调用 iframe3
      // for demo, pattern: if this.id === 'iframe2' -> call iframe3
      const to = myId === 'iframe2' ? 'iframe3' : 'iframe1';
      const payloadObj = { msg: `${myId} 发出消息 at ${new Date().toLocaleTimeString()}`};
      const key = genKey();
      const encoded = base64Encode(payloadObj);
      // send invoke request to parent (parent 会中转给目标)
      window.parent.postMessage({ type:'invoke', key, from: myId, to, payload: encoded }, '*');

      // 等待响应可以在 parent 返回 response 时处理（上面 message handler 会接收到 response）
    });

    // For debug: 可以主动 log 给 parent
    // window.parent.postMessage({ type:'log', from: myId, payload: base64Encode({note: 'hello parent'}) }, '*');
  </script>
</body>
</html>